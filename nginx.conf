events {
    # Configuration options for events
}

http {
    include /etc/nginx/mime.types;

        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log /var/log/nginx/access.log main;
	
    server {
        listen 443 ssl;
        server_name _;
	ssl_certificate /etc/nginx/cert.pem;
	ssl_certificate_key /etc/nginx/key.pem;


        location /qbittorrent/ {
	    allow 192.168.86.0/24;
	    deny all;
            proxy_pass http://vpn:8080/;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        location /bazarr/ {
	    allow 192.168.86.0/24;
	    deny all;
            proxy_pass http://vpn:6767;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
	    proxy_set_header Upgrade $http_upgrade;
	    proxy_set_header Connection $http_connection;
        }
        location /prowlarr/ {
	    allow 192.168.86.0/24;
	    deny all;
            proxy_pass http://vpn:9696;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
	    proxy_set_header Upgrade $http_upgrade;
	    proxy_set_header Connection $http_connection;
        }
        location /sonarr/ {
	    allow 192.168.86.0/24;
	    deny all;
            proxy_pass http://vpn:8989;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
	    proxy_set_header Upgrade $http_upgrade;
	    proxy_set_header Connection $http_connection;
        }
        location /radarr/ {
	    allow 192.168.86.0/24;
	    deny all;
            proxy_pass http://vpn:7878;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
	    proxy_set_header Upgrade $http_upgrade;
	    proxy_set_header Connection $http_connection;
        }

	location ^~ /jellyseerr {
	        set $app 'jellyseerr';

                # Remove /overseerr path to pass to the app
                rewrite ^/jellyseerr/?(.*)$ /$1 break;
                rewrite ^/overseerr/?(.*)$ /$1 break;
                proxy_pass http://jellyseerr:5055; # NO TRAILING SLASH

                # Redirect location headers
                proxy_redirect ^ /$app;
                proxy_redirect /setup /$app/setup;
                proxy_redirect /login /$app/login;

                # Sub filters to replace hardcoded paths
                proxy_set_header Accept-Encoding "";
                sub_filter_once off;
                sub_filter_types *;
                sub_filter 'href="/"' 'href="/$app"';
                sub_filter 'href="/login"' 'href="/$app/login"';
                sub_filter 'href:"/"' 'href:"/$app"';
                sub_filter '\/_next' '\/$app\/_next';
                sub_filter '/_next' '/$app/_next';
                sub_filter '/api/v1' '/$app/api/v1';
                sub_filter '/login/plex/loading' '/$app/login/plex/loading';
                sub_filter '/images/' '/$app/images/';
                sub_filter '/android-' '/$app/android-';
                sub_filter '/apple-' '/$app/apple-';
                sub_filter '/favicon' '/$app/favicon';
                sub_filter '/logo_' '/$app/logo_';
                sub_filter '/site.webmanifest' '/$app/site.webmanifest';
	}
	
	location /flaresolverr/ {
	    allow 192.168.86.0/24;
	    deny all;
	    proxy_pass http://vpn:8191/;
	    proxy_set_header Host $http_host;
	    proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
	    proxy_set_header Upgrade $http_upgrade;
	    proxy_set_header Connection $http_connection;
	}
	location /jellyfin/ {
	    proxy_pass http://vpn:8096;
	    proxy_set_header Host $http_host;
	    proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
	    proxy_set_header Upgrade $http_upgrade;
	    proxy_set_header Connection $http_connection;
	}

	location /healthcheck {
	    return 200;
	}

	location / {
	    return 404;
        }
    }
}
